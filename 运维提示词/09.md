### **AI 理解用户意图 & 任务分类架构设计**

#### **1. 架构思路**

为了让 AI 能准确理解用户输入，并对不同任务进行分类，我们可以采用 **多层解析架构**，如下：

- **第一层：意图识别（Intent Recognition）** —— 解析用户输入，确定核心需求，例如日志查询、资源监控、告警处理等。
- **第二层：任务拆解（Task Decomposition）** —— 进一步分析任务的具体子任务，如 Elasticsearch 查询、Prometheus 监控、DeepFlow 分析等。
- **第三层：任务执行（Task Execution）** —— 生成适当的查询 API 请求或操作指令，并返回结构化的 JSON 结果。

---

#### **2. AI 解析用户输入的 Prompt 设计**

为了提高 AI 对用户意图的理解，我们可以使用 **DeepSeek** 的 JSON 输出功能，确保结构化响应。

##### **通用 Prompt（示例）**

```
你是一个智能运维助手，负责解析用户输入，并将其映射到预定义的运维任务类别。
请根据用户输入，确定其意图，并将任务分类到以下类别：
- "logs_query"（日志查询）
- "metrics_monitoring"（指标监控）
- "alerts_management"（告警管理）
- "resource_cost_estimation"（资源成本预估）
- "deployment_management"（部署管理）
- "troubleshooting"（故障排查）
- "others"（其他）

如果可能的话，请提取用户的 **查询关键字**，并尝试生成适合的 API 查询参数。

**示例输入：**
"请帮我查询 nginx 在 10.1.1.1 服务器上的访问日志，并找出 5XX 错误率最高的时间段。"

**示例 JSON 输出：**
```json
{
    "intent": "logs_query",
    "query_keywords": ["nginx", "10.1.1.1", "5XX"],
    "suggested_api": {
        "service": "elasticsearch",
        "query": {
            "index": "nginx-logs",
            "filter": "host:10.1.1.1 AND status:5XX",
            "aggregation": "time_histogram"
        }
    }
}
```

```

---

#### **3. 任务分类的 JSON Schema**
为了让 AI 始终返回结构化 JSON 响应，我们可以设计如下 JSON Schema：

```json
{
    "type": "object",
    "properties": {
        "intent": {
            "type": "string",
            "enum": [
                "logs_query",
                "metrics_monitoring",
                "alerts_management",
                "resource_cost_estimation",
                "deployment_management",
                "troubleshooting",
                "others"
            ]
        },
        "query_keywords": {
            "type": "array",
            "items": {
                "type": "string"
            }
        },
        "suggested_api": {
            "type": "object",
            "properties": {
                "service": { "type": "string" },
                "query": { "type": "object" }
            },
            "required": ["service", "query"]
        }
    },
    "required": ["intent"]
}
```

---

#### **4. AI 任务分类 & 解析示例**

##### **示例 1：日志查询**

**用户输入**

```
请查询 2024-04-01 服务器 192.168.1.100 的 Nginx 访问日志，筛选出 500 错误的请求详情。
```

**AI 解析的 JSON 响应**

```json
{
    "intent": "logs_query",
    "query_keywords": ["Nginx", "192.168.1.100", "500 error"],
    "suggested_api": {
        "service": "elasticsearch",
        "query": {
            "index": "nginx-logs",
            "filter": "host:192.168.1.100 AND status:500",
            "fields": ["timestamp", "url", "response_time"]
        }
    }
}
```

---

##### **示例 2：资源成本预估**

**用户输入**

```
如果我要扩展 5 台 16 核 64G 的云服务器，并且每天运行 24 小时，预计一个月的费用是多少？
```

**AI 解析的 JSON 响应**

```json
{
    "intent": "resource_cost_estimation",
    "query_keywords": ["5 台", "16 核 64G", "每天 24 小时", "一个月"],
    "suggested_api": {
        "service": "cloud_cost_estimator",
        "query": {
            "instance_type": "16C64G",
            "quantity": 5,
            "usage_hours_per_day": 24,
            "duration_days": 30
        }
    }
}
```

---

##### **示例 3：Prometheus 监控指标**

**用户输入**

```
请查询 Kubernetes 集群中 `node_cpu_utilization` 指标，过去 1 小时内各节点的 CPU 使用率趋势。
```

**AI 解析的 JSON 响应**

```json
{
    "intent": "metrics_monitoring",
    "query_keywords": ["Kubernetes", "node_cpu_utilization", "1 小时"],
    "suggested_api": {
        "service": "prometheus",
        "query": {
            "metric": "node_cpu_utilization",
            "time_range": "1h",
            "aggregation": "node"
        }
    }
}
```

---

#### **5. 代码实现**

```python
import json
from openai import OpenAI

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.deepseek.com"
)

system_prompt = """
你是一个智能运维助手，负责解析用户输入，并将其映射到以下运维任务类别：
- "logs_query"（日志查询）
- "metrics_monitoring"（指标监控）
- "alerts_management"（告警管理）
- "resource_cost_estimation"（资源成本预估）
- "deployment_management"（部署管理）
- "troubleshooting"（故障排查）
- "others"（其他）

请提取用户的 **查询关键字**，并尝试生成适合的 API 查询参数。以 JSON 形式返回结果。
"""

def get_ai_response(user_input):
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_input}
    ]
    
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=messages,
        response_format={"type": "json_object"}
    )
    
    return json.loads(response.choices[0].message.content)

# 示例测试
user_query = "请查询 2024-04-01 服务器 192.168.1.100 的 Nginx 访问日志，筛选出 500 错误的请求详情。"
parsed_response = get_ai_response(user_query)
print(json.dumps(parsed_response, indent=2, ensure_ascii=False))
```

---

#### **6. 总结**

- 通过 **意图分类 + 任务拆解 + API 映射**，让 AI 能精准处理各种运维请求。
- 使用 **JSON 输出** 确保返回结构化数据，便于程序解析与自动化执行。
- 采用 **灵活 Prompt 设计**，让 AI 适应不同类型的运维需求。
- 代码示例可以直接接入 **DeepSeek API**，用于智能运维助手的开发。

你可以结合你的 **运维平台（项目-应用-节点-组件）**，进一步优化 API 参数映射，让 AI 适应你的运维体系 🚀
