## **工单分类 & AI 解析方案**

在 **宝尊电商运维平台** 里，用户的请求涉及多个具体工单类型，如 **发布工单、资源申请工单、数据库工单、扩容工单等**。  
AI 需要解析用户输入，**自动匹配合适的工单类型**，并 **生成标准化 JSON 结构** 以便提交至 **运维系统**。  

---

## **1. 工单分类**

| 工单类型 | 适用场景 | 关键字段 |
|---------|---------|---------|
| **发布工单** | 代码上线、灰度发布 | 应用名称、环境、版本、审批人 |
| **资源申请工单** | 新增服务器、扩展存储 | 资源类型、规格、数量 |
| **数据库 DML 工单** | 数据插入、更新、删除 | 数据库、SQL 语句、影响范围 |
| **数据库 DDL 工单** | 新建表、索引变更 | 数据库、表结构、变更内容 |
| **Nginx 工单** | 负载均衡、域名解析 | Nginx 配置、目标主机 |
| **技术支持工单** | 业务疑问、技术故障 | 问题描述、联系人 |
| **运维自定义工单** | 其他特殊运维需求 | 需求详情 |
| **K8s 扩容工单** | Pod 扩展、HPA 变更 | 应用名称、副本数 |
| **虚拟机扩容工单** | CPU / 内存 / 磁盘扩展 | 服务器、扩展规格 |
| **域名解析工单** | DNS 变更 | 域名、解析目标 |

---

## **2. AI 解析 & JSON 生成**

### **示例 1：代码发布工单**

**用户输入**

```
我要上线电商前端 v2.1.3 到生产环境，能帮我生成工单吗？
```

**AI 解析**

```json
{
    "intent": "发布工单",
    "query_keywords": ["上线", "电商前端", "v2.1.3", "生产环境"],
    "ticket": {
        "type": "发布工单",
        "title": "电商前端 v2.1.3 发布",
        "description": "电商前端 v2.1.3 需要上线到生产环境。",
        "application": "电商前端",
        "environment": "生产",
        "version": "v2.1.3",
        "approver": "运维经理",
        "priority": "高",
        "assignee": "发布团队",
        "status": "待审批"
    }
}
```

---

### **示例 2：数据库 DML 工单**

**用户输入**

```
请帮我执行 SQL：UPDATE users SET status='active' WHERE id=1001，在用户数据库里操作。
```

**AI 解析**

```json
{
    "intent": "数据库 DML 工单",
    "query_keywords": ["SQL", "UPDATE", "users", "status", "active"],
    "ticket": {
        "type": "数据库 DML 工单",
        "title": "执行 SQL 变更",
        "description": "在用户数据库执行 SQL 语句：UPDATE users SET status='active' WHERE id=1001。",
        "database": "用户数据库",
        "sql_statement": "UPDATE users SET status='active' WHERE id=1001",
        "approver": "DBA",
        "priority": "中",
        "assignee": "数据库管理员",
        "status": "待审批"
    }
}
```

---

### **示例 3：K8s 扩容工单**

**用户输入**

```
K8s 订单服务 CPU 负载太高，请扩容 3 个 pod。
```

**AI 解析**

```json
{
    "intent": "K8s 扩容工单",
    "query_keywords": ["K8s", "订单服务", "CPU 负载", "扩容", "3 个 pod"],
    "ticket": {
        "type": "K8s 扩容工单",
        "title": "K8s 订单服务扩容",
        "description": "订单服务当前 CPU 负载过高，需要扩容 3 个 pod。",
        "application": "订单服务",
        "replica_increase": 3,
        "approver": "SRE",
        "priority": "高",
        "assignee": "K8s 运维团队",
        "status": "待审批"
    }
}
```

---

## **3. 代码实现**

### **AI 解析用户输入**

```python
import json
from openai import OpenAI

client = OpenAI(
    api_key="your-api-key",
    base_url="https://api.deepseek.com"
)

system_prompt = """
你是一个智能运维助手，负责解析用户输入，并将其映射到以下工单类别：
- "发布工单"
- "资源申请工单"
- "数据库 DML 工单"
- "数据库 DDL 工单"
- "Nginx 工单"
- "技术支持工单"
- "运维自定义工单"
- "K8s 扩容工单"
- "虚拟机扩容工单"
- "域名解析工单"

然后，你需要返回一个 **标准化 JSON**：
{
    "intent": "K8s 扩容工单",
    "query_keywords": ["K8s", "订单服务", "CPU 负载", "扩容"],
    "ticket": {
        "type": "K8s 扩容工单",
        "title": "K8s 订单服务扩容",
        "description": "订单服务 CPU 负载过高，需要扩容 3 个 pod。",
        "application": "订单服务",
        "replica_increase": 3,
        "approver": "SRE",
        "priority": "高",
        "assignee": "K8s 运维团队",
        "status": "待审批"
    }
}
"""

def generate_ticket(user_input):
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_input}
    ]
    
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=messages,
        response_format={"type": "json_object"}
    )
    
    return json.loads(response.choices[0].message.content)

# 示例测试
user_query = "K8s 订单服务 CPU 负载太高，请扩容 3 个 pod。"
parsed_response = generate_ticket(user_query)
print(json.dumps(parsed_response, indent=2, ensure_ascii=False))
```

---

## **4. 工单系统对接**

可以直接提交 JSON 结果到 Jira、ITSM 或内部工单系统。

```python
import requests

def submit_ticket(ticket_data):
    jira_api_url = "https://your-jira-instance.com/rest/api/2/issue"
    headers = {"Content-Type": "application/json"}
    
    jira_payload = {
        "fields": {
            "project": {"key": "OPS"},
            "summary": ticket_data["ticket"]["title"],
            "description": ticket_data["ticket"]["description"],
            "priority": {"name": ticket_data["ticket"]["priority"]},
            "assignee": {"name": ticket_data["ticket"]["assignee"]},
            "status": ticket_data["ticket"]["status"]
        }
    }

    response = requests.post(jira_api_url, json=jira_payload, headers=headers, auth=("user", "password"))
    return response.json()

# 提交工单
ticket_response = submit_ticket(parsed_response)
print(ticket_response)
```

---

## **5. 业务价值**

✅ **自动工单匹配**：解析用户需求，自动归类到正确的工单类型  
✅ **减少人工操作**：自动填充工单信息，减少手工输入错误  
✅ **集成监控系统**：与 Prometheus、DeepFlow、ELK 结合，实现自动扩容 & 故障分析  
✅ **适配宝尊电商业务**：支持 **发布、数据库、K8s、Nginx、虚拟机、域名** 等全方位运维需求  

🚀 **下一步**：可接入 **Slack / 飞书机器人**，让 AI 直接在 IM 里生成工单！
