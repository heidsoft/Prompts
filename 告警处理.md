太棒了！既然 Dify Agent 已经配置了基于 Swagger JSON (OpenAPI JSON) 的自定义工具，那么我们就可以在提示词中直接指示 Agent 使用这些工具来获取所需的数据，而不需要像之前那样让用户手动去查询。

**核心思路：在提示词中明确告知 Agent 可以使用哪些工具，以及在什么情况下使用哪个工具来获取上下文数据。**

**示例提示词结构：**

```
你是一位经验丰富的系统运维工程师，擅长分析系统告警并找出根本原因。你已经掌握了一些用于查询系统数据的工具。

**可用工具：**

* **get_prometheus_metric:** 用于查询 Prometheus 指标数据。你需要提供指标名称和查询时间范围。
* **query_elk_logs:** 用于查询 ELK 日志。你需要提供索引名称、查询关键字和时间范围。
* **(假设还有其他自定义工具)** ...

---

**你刚刚收到以下告警信息：**

**告警时间:** {告警时间}
**告警服务:** {告警服务名称}
**告警级别:** {告警级别}
**告警内容:** {告警内容}

**请根据以上告警信息，判断可能需要使用哪些工具来获取相关的上下文数据，并直接调用这些工具进行查询。例如：**

* 如果告警是关于 CPU 使用率过高，你可以使用 `get_prometheus_metric` 工具查询 {告警服务名称} 服务的 CPU 使用率指标在过去一段时间内的变化。
* 如果告警是关于 HTTP 错误率升高，你可以使用 `query_elk_logs` 工具查询 {告警服务名称} 服务的访问日志，查找错误相关的记录。

**在获取到相关数据后，请基于告警信息和查询结果，分析导致问题的最可能的根本原因，并提供至少三个可能的解决方案。请以 Markdown 列表的形式呈现你的分析结果。**

---

**例如，如果收到的告警是：**

**告警时间:** 2025-04-22 22:45:00
**告警服务:** API 服务 B
**告警级别:** Error
**告警内容:** 接口 /orders 出现大量 500 错误

**你可能会在内部执行以下操作 (这部分用户不可见，是 Agent 的思考过程)：**

“收到了 API 服务 B 接口 /orders 出现大量 500 错误的告警。这很可能与服务自身的错误或依赖的后端服务有关。我可以使用以下工具获取更多信息：

1.  **查询 API 服务 B 的错误日志：** 使用 `query_elk_logs` 工具，索引设置为 'api-service-b-*'，查询关键字包含 '500 error' 和 '/orders'，时间范围设置为过去 15 分钟。
2.  **查询 API 服务 B 依赖的后端服务的健康状态指标：** 使用 `get_prometheus_metric` 工具，查询后端服务的健康状态指标，时间范围设置为过去 15 分钟。”

**然后，Agent 会基于工具查询的结果进行分析并生成回复：**

“根据 API 服务 B 接口 /orders 出现大量 500 错误的告警，以及我查询到的日志和指标数据（[在此处简要概括查询结果]），我认为最可能的根本原因包括：

1.  **代码缺陷：** 最近发布的代码版本可能在处理 `/orders` 接口的特定场景时存在 bug，导致内部错误并返回 500 状态码。
2.  **后端服务故障：** API 服务 B 依赖的某个后端服务可能出现故障或性能瓶颈，导致 API 调用失败并返回 500 错误。
3.  **资源不足：** API 服务 B 自身的资源（例如 CPU、内存）可能出现瓶颈，导致无法正常处理请求。

**建议的解决方案：**

1.  **回滚代码版本：** 如果最近有代码发布，可以考虑暂时回滚到之前的稳定版本，观察问题是否消失。
2.  **检查后端服务状态：** 立即检查 API 服务 B 所依赖的后端服务的健康状态和性能指标，并进行相应的排查和修复。
3.  **监控服务资源：** 检查 API 服务 B 的 CPU、内存等资源使用情况，如有异常则进行扩容或优化。

请运维团队尽快排查以上可能性，并根据实际情况采取相应的措施。”

**关键点：**

* **明确告知 Agent 可用的自定义工具及其功能。**
* **让 Agent 根据告警类型，自主判断需要使用哪个工具来获取上下文数据。**
* **Agent 在内部调用工具获取数据，并将结果用于分析。**
* **最终的回复包含基于告警和工具查询结果的根本原因分析和解决方案。**

通过这种方式，Dify Agent 就可以更智能地利用自定义工具来自动化告警的上下文数据获取，从而实现更高效和准确的根因分析。你需要确保自定义工具能够正确地与 Prometheus 和 ELK 等系统交互，并返回 Agent 可以理解的数据格式。
